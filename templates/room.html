<!doctype html>
<html lang="{{ lang }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Piknik Vakti â€” {{ code }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='app.css') }}">
</head>
<body>
<div class="container">
  <div class="header">
    <a href="/" class="badge">â† Geri</a>
    <div class="lang">
      <a href="?username={{ username }}&lang=tr{{ '&view=1' if view else '' }}" class="{{ 'active' if lang=='tr' else '' }}" data-lang="tr">ğŸ‡¹ğŸ‡· TR</a>
      <a href="?username={{ username }}&lang=en{{ '&view=1' if view else '' }}" class="{{ 'active' if lang=='en' else '' }}" data-lang="en">ğŸ‡¬ğŸ‡§ EN</a>
    </div>
  </div>

  <h1>ğŸ“… Piknik Vakti â€” {{ code if not view else (code[:2] + '**') }}</h1>
  <div class="small">
    <span id="date">â€”</span> Â·
    <b id="user">{{ username }}</b>
    {% if view %} Â· <b id="readonly">ğŸ”’ Sadece gÃ¶rÃ¼ntÃ¼lÃ¼yorsunuz</b>{% endif %}
  </div>

  <div class="card">
    <h2>âš¡ HÄ±zlÄ± ekle</h2>
    <div id="cats" class="chips"></div>
    <hr class="chips-sep">
    <div id="subchips" class="chips"></div>

    <div class="row" style="margin-top:10px">
      <input id="itemName" placeholder="ÃœrÃ¼n adÄ± (Ã¶rn. KaÅŸar)">
      <select id="unit">
        <option value="kg">kg</option>
        <option value="adet">adet</option>
        <option value="lt">lt</option>
      </select>
      <input id="amount" value="1">
      <button id="add" class="primary" {% if view %}disabled{% endif %}>Ekle</button>
    </div>
    <div id="quick" class="quick"></div>
  </div>

  <div class="card">
    <h2>ğŸ§º ÃœrÃ¼nler</h2>
    <div id="list" class="list"></div>
  </div>
</div>

<script>
/* ====== Room data / list loop â€“ mevcut iÅŸleyiÅŸ korunur ====== */
const ROOM   ="{{ code }}";
const USER   ="{{ username }}";
const VIEW   = {{ 'true' if view else 'false' }};

/* --------- KANONÄ°K KATEGORÄ° MODELÄ° (TR + EN + emoji) ---------- */
const CATS = [
  {
    key:'fruit', icon:'ğŸ“', tr:'Meyve', en:'Fruit',
    subs:[
      {icon:'ğŸ', tr:'Elma',      en:'Apple'},
      {icon:'ğŸ', tr:'Armut',     en:'Pear'},
      {icon:'ğŸ‡', tr:'ÃœzÃ¼m',      en:'Grapes'},
      {icon:'ğŸ‰', tr:'Karpuz',    en:'Watermelon'},
      {icon:'ğŸŠ', tr:'Portakal',  en:'Orange'},
      {icon:'ğŸŒ', tr:'Muz',       en:'Banana'},
      {icon:'ğŸŠ', tr:'Mandalina', en:'Mandarin'},
      {icon:'ğŸ“', tr:'Ã‡ilek',     en:'Strawberry'},
      {icon:'ğŸ‘', tr:'Åeftali',   en:'Peach'},
      {icon:'ğŸˆ', tr:'Kavun',     en:'Melon'},
    ]
  },
  { key:'veg',   icon:'ğŸ¥’', tr:'Sebze',            en:'Vegetables',
    subs:[
      {icon:'ğŸ…', tr:'Domates',     en:'Tomato'},
      {icon:'ğŸ§…', tr:'SoÄŸan',       en:'Onion'},
      {icon:'ğŸ«‘', tr:'Biber',       en:'Pepper'},
      {icon:'ğŸ¥”', tr:'Patates',     en:'Potato'},
      {icon:'ğŸŒ½', tr:'MÄ±sÄ±r (koÃ§an)', en:'Corn (cob)'},
      {icon:'ğŸ¥¬', tr:'Marul',       en:'Lettuce'},
      {icon:'ğŸ¥¬', tr:'Roka',        en:'Arugula'},
      {icon:'ğŸ„', tr:'Mantar',      en:'Mushroom'},
      {icon:'ğŸ§„', tr:'SarÄ±msak',    en:'Garlic'},
      {icon:'ğŸ†', tr:'PatlÄ±can',    en:'Eggplant'},
    ]
  },
  { key:'bbq',   icon:'ğŸ¥©', tr:'Et/Mangal',        en:'Grill/BBQ',
    subs:[
      {icon:'ğŸ¥©', tr:'KÃ¶fte',       en:'Meatball'},
      {icon:'ğŸ—', tr:'Tavuk',       en:'Chicken'},
      {icon:'ğŸŒ­', tr:'Sucuk',       en:'Sausage'},
      {icon:'ğŸ–', tr:'Mangal',      en:'Grill'},
      {icon:'ğŸ§°', tr:'Izgara Teli', en:'Grill Net'},
      {icon:'ğŸª¨', tr:'Mangal KÃ¶mÃ¼rÃ¼', en:'Charcoal'},
      {icon:'ğŸ¢', tr:'ÅiÅŸ',         en:'Skewer'},
    ]
  },
  { key:'bakery',icon:'ğŸ', tr:'Ekmek/Unlu',       en:'Bakery',
    subs:[
      {icon:'ğŸ¥–', tr:'Ekmek',   en:'Bread'},
      {icon:'ğŸ«“', tr:'LavaÅŸ',   en:'Lavash'},
      {icon:'ğŸ¥¯', tr:'Simit',   en:'Bagel'},
      {icon:'ğŸ«“', tr:'Tortilla',en:'Tortilla'},
    ]
  },
  { key:'dairy', icon:'ğŸ§€', tr:'Peynir/ÅarkÃ¼teri', en:'Dairy/Charcuterie',
    subs:[
      {icon:'ğŸ§€', tr:'KaÅŸar',        en:'Cheddar'},
      {icon:'ğŸ§€', tr:'Beyaz Peynir', en:'White Cheese'},
      {icon:'ğŸ¥ª', tr:'Sucuk Dilim',  en:'Sausage Slices'},
      {icon:'ğŸ¥ª', tr:'Salam',        en:'Salami'},
      {icon:'ğŸŒ­', tr:'Sosis',        en:'Hot Dog'},
    ]
  },
  { key:'salad', icon:'ğŸ¥—', tr:'Salata/Meze',     en:'Salads/Mezes',
    subs:[
      {icon:'ğŸ¥—', tr:'Mevsim Salata', en:'Season Salad'},
      {icon:'ğŸ¥—', tr:'GavurdaÄŸÄ±',     en:'Gavurdagi'},
      {icon:'ğŸ«˜', tr:'Humus',         en:'Hummus'},
      {icon:'ğŸ¥£', tr:'Haydari',       en:'Haydari'},
      {icon:'ğŸŒ¶ï¸', tr:'AcÄ±lÄ± Ezme',   en:'Spicy Ezme'},
      {icon:'ğŸ¥«', tr:'Mayonez',       en:'Mayonnaise'},
      {icon:'ğŸ¥«', tr:'KetÃ§ap',        en:'Ketchup'},
      {icon:'ğŸ¥«', tr:'Hardal',        en:'Mustard'},
      {icon:'ğŸŒ¿', tr:'Maydanoz',      en:'Parsley'},
    ]
  },
  { key:'drink', icon:'ğŸ¥¤', tr:'Ä°Ã§ecek',          en:'Drinks',
    subs:[
      {icon:'ğŸ’§', tr:'Su',          en:'Water'},
      {icon:'ğŸ¥¤', tr:'Kola',        en:'Cola'},
      {icon:'ğŸ¥›', tr:'Ayran',       en:'Ayran'},
      {icon:'ğŸ«—', tr:'Maden Suyu',  en:'Mineral Water'},
      {icon:'ğŸ¥¤', tr:'Gazoz',       en:'Soda Pop'},
    ]
  },
  { key:'cond',  icon:'ğŸ§‚', tr:'Sos/Condiment',   en:'Sauces/Condiments',
    subs:[
      {icon:'ğŸ§‚', tr:'Tuz',       en:'Salt'},
      {icon:'ğŸ§‚', tr:'Karabiber', en:'Black Pepper'},
      {icon:'ğŸŒ¶ï¸', tr:'Pul Biber', en:'Chili Flakes'},
      {icon:'ğŸ§‚', tr:'Sumak',     en:'Sumac'},
      {icon:'ğŸ§‚', tr:'Kimyon',    en:'Cumin'},
    ]
  },
  { key:'brk',   icon:'ğŸ¯', tr:'KahvaltÄ±lÄ±k',     en:'Breakfast',
    subs:[
      {icon:'ğŸ«’', tr:'Zeytin', en:'Olives'},
      {icon:'ğŸ¯', tr:'ReÃ§el',  en:'Jam'},
      {icon:'ğŸ¯', tr:'Bal',    en:'Honey'},
      {icon:'ğŸ¥«', tr:'Tahin',  en:'Tahini'},
      {icon:'ğŸ¥«', tr:'Pekmez', en:'Molasses'},
    ]
  },
  { key:'hyg',   icon:'ğŸ§½', tr:'Temizlik/Hijyen', en:'Cleaning/Hygiene',
    subs:[
      {icon:'ğŸ§»', tr:'Islak Mendil',       en:'Wet Wipes'},
      {icon:'ğŸ§»', tr:'PeÃ§ete',             en:'Napkin'},
      {icon:'ğŸ§´', tr:'BulaÅŸÄ±k DeterjanÄ±',  en:'Dish Soap'},
      {icon:'ğŸ§´', tr:'SÄ±vÄ± Sabun',         en:'Liquid Soap'},
    ]
  },
  { key:'disp',  icon:'ğŸ½ï¸', tr:'Tek KullanÄ±mlÄ±k', en:'Disposable',
    subs:[
      {icon:'ğŸ½ï¸', tr:'Tabak',  en:'Plate'},
      {icon:'ğŸ¥¤', tr:'Bardak',  en:'Cup'},
      {icon:'ğŸ´', tr:'Ã‡atal',  en:'Fork'},
      {icon:'ğŸ”ª', tr:'BÄ±Ã§ak',  en:'Knife'},
      {icon:'ğŸ¥„', tr:'KaÅŸÄ±k',  en:'Spoon'},
    ]
  },
  { key:'cool',  icon:'ğŸ§Š', tr:'SoÄŸutma/Buz',     en:'Cooling/Ice',
    subs:[
      {icon:'ğŸ§Š', tr:'Buz',       en:'Ice'},
      {icon:'ğŸ§Š', tr:'SoÄŸutucu',  en:'Cooler'},
      {icon:'ğŸ§Š', tr:'Buz AkÃ¼sÃ¼', en:'Ice Pack'},
    ]
  },
  { key:'tools', icon:'ğŸ§°', tr:'Ekipman/Alet',    en:'Equipment/Tool',
    subs:[
      {icon:'ğŸ”ª', tr:'Kesme TahtasÄ±', en:'Cutting Board'},
      {icon:'ğŸ”ª', tr:'BÄ±Ã§ak',         en:'Knife Tool'},
      {icon:'ğŸ› ï¸', tr:'MaÅŸa',         en:'Tongs'},
      {icon:'ğŸ—‘ï¸', tr:'Ã‡Ã¶p PoÅŸeti',   en:'Trash Bag'},
    ]
  },
  { key:'other', icon:'â‡ï¸', tr:'DiÄŸer',           en:'Other',
    subs:[
      {icon:'ğŸ²', tr:'Oyun',            en:'Game'},
      {icon:'ğŸ”Š', tr:'MÃ¼zik HoparlÃ¶r',  en:'Speaker'},
      {icon:'ğŸ§º', tr:'Piknik Ã–rtÃ¼sÃ¼',   en:'Picnic Blanket'},
    ]
  },
];

/* label -> icon reverse map (TR ve EN) */
const LABEL_MAP = {};
(function buildLabelMap(){
  for(const c of CATS){
    LABEL_MAP[c.tr.toLowerCase()] = c.icon;
    LABEL_MAP[c.en.toLowerCase()] = c.icon;
    for(const s of c.subs){
      LABEL_MAP[s.tr.toLowerCase()] = s.icon;
      LABEL_MAP[s.en.toLowerCase()] = s.icon;
    }
  }
})();
function iconFor(label){
  return LABEL_MAP[(label||'').toLowerCase()] || 'ğŸ§º';
}

/* ---------- Dil yardÄ±mcÄ±larÄ± ---------- */
function getLang(){ return (localStorage.getItem('lang') || document.documentElement.lang || '{{ lang }}' || 'tr').toLowerCase(); }
function setLang(l){ localStorage.setItem('lang', l); document.documentElement.lang = l; }

/* ---------- Birim Ã¶nerisi & hÄ±zlÄ± miktar ---------- */
function inferUnitByName(n){
  const s=(n||'').toLowerCase();
  const LIQ_TR = ['su','ayran','kola','gazoz','maden'];
  const LIQ_EN = ['water','cola','soda','mineral'];
  const PCS_TR = ['ekmek','lavaÅŸ','simit','ketÃ§ap','mayonez','hardal','tabak','bardak','Ã§atal','bÄ±Ã§ak','kaÅŸÄ±k','Ä±zgara','mangal','kÃ¶mÃ¼rÃ¼','ÅŸiÅŸ','peÃ§ete','Ä±slak','buz','akÃ¼sÃ¼','soÄŸutucu','kesme','maÅŸa','Ã§Ã¶p','humus','haydari'];
  const PCS_EN = ['bread','lavash','bagel','ketchup','mayonnaise','mustard','plate','cup','fork','knife','spoon','grill','charcoal','skewer','napkin','wipe','ice','cooler','cutting','tongs','trash','hummus','haydari'];
  if ([...LIQ_TR, ...LIQ_EN].some(k=>s.includes(k))) return 'lt';
  if ([...PCS_TR, ...PCS_EN].some(k=>s.includes(k))) return 'adet';
  return 'kg';
}
function quickSetFor(unit){
  if(unit==='kg') return [0.5,1,2,3,4,5];
  if(unit==='lt') return [0.5,1,2,5,10];
  return [0.5,1,2,3,5];
}

/* ---------- UI baÄŸlantÄ±larÄ± ---------- */
const catsDiv   = document.getElementById('cats');
const subsDiv   = document.getElementById('subchips');
const nameInp   = document.getElementById('itemName');
const unitSel   = document.getElementById('unit');
const amountInp = document.getElementById('amount');
const quickDiv  = document.getElementById('quick');
const listDiv   = document.getElementById('list');

let CURRENT_CAT = null;
let OWNER = '';

/* ---------- Kategori & alt Ã¼rÃ¼n Ã§izimi (dile gÃ¶re) ---------- */
function renderCategories(lang){
  if(!catsDiv) return;
  catsDiv.innerHTML='';
  CATS.forEach(c=>{
    const b=document.createElement('button');
    b.type='button';
    b.className='chip';
    b.dataset.key=c.key;
    b.innerHTML = `${c.icon} ${c[lang]}`;
    b.onclick=()=>{ CURRENT_CAT=c; renderSubchips(lang); };
    catsDiv.appendChild(b);
  });
}
function renderSubchips(lang, existingNames=[]){
  if(!subsDiv) return;
  subsDiv.innerHTML='';
  if(!CURRENT_CAT) return;
  const exist = new Set(existingNames.map(s=>s.toLowerCase()));
  CURRENT_CAT.subs.forEach(s=>{
    const label = `${s.icon} ${s[lang]}`;
    const chip  = document.createElement('button');
    chip.type='button';
    chip.className='chip'+(exist.has(s[lang].toLowerCase())?' disabled':'');
    chip.innerHTML=label;
    chip.onclick=()=>{
      nameInp.value = s[lang];
      const u = inferUnitByName(nameInp.value);
      unitSel.value = u;
      renderQuickChips(lang);
    };
    subsDiv.appendChild(chip);
  });
}

/* ---------- HÄ±zlÄ± miktar Ã§ipleri ---------- */
function renderQuickChips(lang){
  if(!quickDiv) return;
  quickDiv.innerHTML='';
  const unit = unitSel.value || 'kg';
  const suffix = (lang==='tr') ? {kg:'kg', lt:'lt', adet:'adet'} : {kg:'kg', lt:'L', adet:'pcs'};
  quickSetFor(unit).forEach(n=>{
    const chip=document.createElement('button');
    chip.type='button'; chip.className='chip';
    chip.textContent=`${n} ${suffix[unit]||unit}`;
    chip.onclick=()=>{ amountInp.value=n; if(!VIEW) addItem(); };
    quickDiv.appendChild(chip);
  });
}

/* ---------- Sunucu API ---------- */
async function getRoom(){
  const r=await fetch(`/api/room/${ROOM}`);
  return await r.json();
}
async function addItemAPI(body){
  const r=await fetch(`/api/room/${ROOM}/items`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(body)
  });
  if(!r.ok){ alert(await r.text()); }
}
async function patchItem(id,state){
  await fetch(`/api/room/${ROOM}/items/${id}`,{
    method:'PATCH',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({user:USER,state})
  });
}
async function deleteItem(id){
  await fetch(`/api/room/${ROOM}/items/${id}?user=${encodeURIComponent(USER)}`,{method:'DELETE'});
}
function canEdit(owner,u){ return !VIEW && (USER===u || USER===owner); }

/* ---------- Liste Ã§izimi ---------- */
function renderList(items){
  listDiv.innerHTML='';
  const names = items.map(i=>i.name);
  renderSubchips(getLang(), names);  // mevcut isimleri gizle
  items.forEach(it=>{
    const row=document.createElement('div');
    row.className='item '+(it.state==='needed'?'needed':(it.state==='brought'?'brought':''));

    const left=document.createElement('div'); left.className='item-left';
    const title=document.createElement('div'); title.className='item-title';
    title.textContent=`${iconFor(it.name)} ${it.name} â€” ${it.amount} ${it.unit}`;
    const meta=document.createElement('div'); meta.className='item-meta';
    meta.textContent=`${it.cat} Â· @${it.user}`;
    left.append(title,meta);

    const act=document.createElement('div'); act.className='actions';
    const bN=document.createElement('button'); bN.className='btn state needed'+(it.state==='needed'?' active':''); bN.textContent='Eksik';
    const bC=document.createElement('button'); bC.className='btn state claimed'+(it.state==='claimed'?' active':''); bC.textContent='AyrÄ±lan';
    const bB=document.createElement('button'); bB.className='btn state brought'+(it.state==='brought'?' active':''); bB.textContent='Getirildi';
    const del=document.createElement('button'); del.className='btn'; del.textContent='Sil';

    if(canEdit(OWNER,it.user)){
      bN.onclick=()=>patchItem(it.id,'needed');
      bC.onclick=()=>patchItem(it.id,'claimed');
      bB.onclick=()=>patchItem(it.id,'brought');
      del.onclick=()=>deleteItem(it.id);
    }else{
      [bN,bC,bB,del].forEach(b=>{b.disabled=true; b.style.opacity=.5;});
    }
    act.append(bN,bC,bB,del);
    row.append(left,act);
    listDiv.appendChild(row);
  });
}

/* ---------- ÃœrÃ¼n ekleme (buton ya da hÄ±zlÄ± Ã§ip) ---------- */
async function addItem(){
  let name=(nameInp.value||'').trim();
  if(!name){ alert(getLang()==='tr'?'ÃœrÃ¼n adÄ± gerekli':'Item name required'); return; }
  const unit = unitSel.value || inferUnitByName(name);
  let amount = parseFloat(amountInp.value||'1'); if(isNaN(amount)||amount<=0) amount=1;

  const lang = getLang();
  const catLabel = CURRENT_CAT ? CURRENT_CAT[lang] : (lang==='tr'?'DiÄŸer':'Other');

  await addItemAPI({name,unit,amount,cat:catLabel,user:USER});
  nameInp.value='';
}

/* ---------- DÃ¶ngÃ¼ ---------- */
async function loop(){
  try{
    const data=await getRoom();
    OWNER = data.owner || OWNER;
    const dateEl=document.getElementById('date');
    if(dateEl) dateEl.textContent = data.date || 'â€”';
    renderList(data.items || []);
  }catch(e){}
  setTimeout(loop, 2000);
}

/* ======= I18N: statik metinler + liste butonlarÄ± ======= */
const UI = {
  tr: {
    back:"â† Geri", quick_add:"HÄ±zlÄ± ekle", items:"ÃœrÃ¼nler", add:"Ekle",
    needed:"Eksik", claimed:"AyrÄ±lan", brought:"Getirildi",
    ph_item:"ÃœrÃ¼n adÄ± (Ã¶rn. KaÅŸar)", unit_kg:"kg", unit_lt:"lt", unit_adet:"adet",
    readonly:"ğŸ”’ Sadece gÃ¶rÃ¼ntÃ¼lÃ¼yorsunuz"
  },
  en: {
    back:"â† Back", quick_add:"Quick add", items:"Items", add:"Add",
    needed:"Needed", claimed:"Claimed", brought:"Brought",
    ph_item:"Item name (e.g. Cheddar)", unit_kg:"kg", unit_lt:"L", unit_adet:"pcs",
    readonly:"ğŸ”’ View-only"
  }
};

function translateStatic(){
  const L = UI[getLang()];
  // baÅŸlÄ±klar
  document.querySelectorAll('h2').forEach(h=>{
    const t = h.textContent.toLowerCase();
    if(t.includes('hÄ±zlÄ±') || t.includes('quick')) {
      h.childNodes.forEach(n=>{ if(n.nodeType===3) n.textContent=' '+L.quick_add; });
    }
    if(t.includes('Ã¼rÃ¼n') || t.includes('items')) {
      h.childNodes.forEach(n=>{ if(n.nodeType===3) n.textContent=' '+L.items; });
    }
  });
  const back = document.querySelector('.header a.badge'); if(back) back.textContent=L.back;
  const ro = document.getElementById('readonly'); if(ro) ro.textContent=L.readonly;
  const addBtn=document.getElementById('add'); if(addBtn) addBtn.textContent=L.add;
  if(nameInp) nameInp.placeholder=L.ph_item;
  if(unitSel){
    const o=unitSel.options;
    if(o[0]) o[0].text=L.unit_kg;
    if(o[1]) o[1].text=L.unit_adet;
    if(o[2]) o[2].text=L.unit_lt;
  }
}

function translateList(){
  const L = UI[getLang()];
  document.querySelectorAll('.btn.state.needed').forEach(b=>b.textContent=L.needed);
  document.querySelectorAll('.btn.state.claimed').forEach(b=>b.textContent=L.claimed);
  document.querySelectorAll('.btn.state.brought').forEach(b=>b.textContent=L.brought);
  document.querySelectorAll('.item .item-title').forEach(t=>{
    const m = t.textContent.match(/â€”\s*([0-9.]+)\s*(kg|lt|l|adet|pcs)/i);
    if(m){
      const num=m[1]; let u=(m[2]||'kg').toLowerCase();
      let out=L.unit_kg; if(u==='lt'||u==='l') out=L.unit_lt; if(u==='adet'||u==='pcs') out=L.unit_adet;
      t.textContent = t.textContent.replace(/â€”\s*[0-9.]+\s*(kg|lt|l|adet|pcs)/i, `â€” ${num} ${out}`);
    }
  });
}

/* ---------- Dil uygulama ---------- */
function applyLanguage(){
  const lang=getLang();
  translateStatic();
  renderCategories(lang);
  const first = CATS[0]; if(first){ CURRENT_CAT=first; renderSubchips(lang); }
  renderQuickChips(lang);
  translateList();
}

/* ---------- Event baÄŸlama ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  applyLanguage();
  loop();
  if(unitSel) unitSel.addEventListener('change', ()=>renderQuickChips(getLang()));
  if(nameInp) nameInp.addEventListener('input', ()=>{
    const u=inferUnitByName(nameInp.value||''); unitSel.value=u; renderQuickChips(getLang());
  });
});
document.querySelectorAll('.lang a[data-lang]').forEach(a=>{
  a.addEventListener('click', (e)=>{
    e.preventDefault();
    setLang((a.dataset.lang||'tr').toLowerCase());
    applyLanguage();
  });
});
// Dinamik liste yenilemeleri iÃ§in kÃ¼Ã§Ã¼k tazeleme
setInterval(translateList, 1200);
</script>
</body>
</html>
